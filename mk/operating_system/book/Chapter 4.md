# 4장. 스레드와 병행성

## 4.1. 개요
스레드란 : CPU 이용의 기본 단위
스레드의 구성
- 스레드 ID
- 프로그램 카운터 (PC)
- 레지스터 집합
- 스택

스레드는 같은 프로세스에 속한 다른 스레드와 다음 요소들을 공유함
- 코드, 데이터 섹션
- 열린 파일
- 신호

프로세스가 다수의 제어 스레드를 보유함으로써 동시에 하나 이상의 작업을 수행할 수 있음

멀티 스레드와 멀티 프로세싱
- 프로세스를 생성하는 작업은 비싼 작업이다
- if 새 프로세스가 기존 프로세스와 동일하다면 : 비싼 프로세스를 생성해서 오버헤드를 감수하는 것 보다 프로세스 안에 여러 개의 스레드를 만드는 것이 훨씬 효율적이다
- 대부분의 운영체제 커널은 다중 스레드 구조이고, 많은 응용 프로그램도 다중 스레드를 활용할 수 있다

다중 스레드 프로그램의 이점
1. 응답성 : 응용 프로그램의 일부분이 봉쇄되거나, 응용 프로그램이 긴 작업을 수행하더라도 프로그램의 수행이 계속되는 것을 허용함으로써 사용자에 대한 응답성을 증가시킴
2. 자원 공유 : 프로세스는 공유 메모리와 메시지 전달 기법을 통해서만 서로 자원을 공유할 수 있지만 스레드는 자동으로 프로세스의 자원들과 메모리를 공유(스택 제외)
3. 경제성 : 프로세스를 생성하는 것보다 스레드를 새로 생성하는 것이 훨씬 저렴하다
4. 규모 적응성 : 다중 처리기 구조에서 다중 스레드의 이점은 더욱 커지는데, 각각의 스레드가 다른 처리기에서 병렬로 수행될 수 있기 때문이다

## 4.2. 다중 코어 프로그래밍
다중 코어 : 단일 컴퓨팅 칩에 여러 컴퓨팅 코어를 배치
- 다중 스레드 프로그래밍은 여러 컴퓨팅 코어를 효율적으로 사용하고 병행성을 향상시키는 기법을 제공

병행성과 병렬성
- 병행성 : 둘 이상의 작업을 지원
- 병렬성 : 동시에 둘 이상의 작업을 수행
- 병렬성 없이 병행성을 가질 수 있다
- CPU 스케쥴러는 프로세스 간 Context Switching을 빠르게 수행해 병렬성의 환상을 일으켰다

다중 코어 시스템이 대세인 현대 사회에서의 프로그래머의 도전 과제
1. 균형 : 전체 작업에 균등한 기여도를 가지도록 스레드 적절히 나누기
2. 데이터 분리 : 스레드가 접근하고 조작하는 데이터 또한 개별 코어에서 사용할 수 있도록 나누어져야 함
3. 데이터 종속성 : 스레드가 접근하는 데이터에 둘 이상의 스레드 사이에 종속성이 없는지 검토해야 함
4. 시험 및 디버깅 : 단일 스레드 프로그램에 비해 훨씬 어렵다

병렬 실행 유형
1. 데이터 병렬 실행 : 동일한 데이터의 부분집합을 다수의 코어에 분배하여 연산
2. 스레드 병렬 실행 : 데이터가 아니라 스레드를 다수의 코어에 분배
- 두 전략은 상호 배타적이지 않고 혼합하여 사용될 수 있다

# 4.3. 다중 스레드 모델
사용자 스레드와 커널 스레드
- 사용자 스레드 : 커널 위에서 지원되며 커널의 지원 없이 제공됨
- 커널 스레드 : 운영 체제에 의해 직접 지원되고 관리됨
- 현대 운영체제들은 커널 스레드를 지원함

다대일 모델
- 많은 사용자 수준 스레드를 하나의 커널 스레드로 사상함
- 하나의 스레드가 봉쇄형 시스템 콜을 호출하면 전체 프로세스가 봉쇄당힘
- 한 번에 하나의 스레드만 커널에 접근 가능하여 병렬 실행 불가능
- 사실상 사장된 모델

일대일 모델
- 각 사용자 스레드를 각각 하나의 커널 스레드로 사상
- 다대일 모델보다 더 많은 병렬성을 제공함
- 다중 처리기에서 다중 스레드의 병렬 수행 허용
- 사용자 스레드 수 만큼 커널 스레드를 만들어야 하는 것이 시스템에 부담을 줄 수 있는 것이 단점

다대다 모델
- 여러 개의 사용자 수준 스레드를 그보다 작은 수 or 같은 수로 멀티플렉싱 함
- 커널 스레드의 수는 어플리케이션 혹은 특정 디바이스에 의해 결정됨
- 진정한 병렬 실행이 불가능한 다대일 모델과, 스레드가 많아질수록 리스크가 커지는 일대일 모델의 단점을 어느 정도 해결했다는 의의가 있음
- 좋아 보이기는 하지만 구현하기 어렵다
- 실제로 HW의 발전으로 시스템의 처리 코어 수가 증가함에 따라 커널 스레드 수를 제한하는 의미가 많이 퇴색됨
- 따라서 현대 OS는 대부분 일대일 모델을 사용함

